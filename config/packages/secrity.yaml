security:
  enable_authenticator_manager: true

  providers:
    database_provider:
      entity:
        class: App\Flags\Entity\User
        property: sub

  password_hashers:
    App\Flags\Entity\User:
      algorithm: bcrypt

  firewalls:
    dev:
      pattern: ^/(_(profiler|wdt)|css|images|js)/
      security: false

    # NEW: Dedicated firewall to handle API Preflights (OPTIONS)
    api_preflight:
      pattern: ^/api
      methods: [OPTIONS]
      security: false # Bypasses all security/authenticators for OPTIONS

    # OAuth login flow (needs sessions for state parameter)
    oauth:
      pattern: ^/(login|oauth)
      stateless: false
      provider: database_provider
      custom_authenticators:
        - App\Flags\Security\HqAuthAuthenticator

    # API endpoints protected by JWT
    api:
      pattern: ^/api
      stateless: true
      provider: database_provider
      jwt: ~

    # Main firewall for web pages
    main:
      lazy: true
      provider: database_provider
      logout:
        path: app_logout

  access_control:
    # Allow OPTIONS requests for all API paths without a token
    - { path: ^/api, methods: [OPTIONS], roles: PUBLIC_ACCESS }
    - { path: ^/login, roles: PUBLIC_ACCESS }
    - { path: ^/oauth/check, roles: PUBLIC_ACCESS }
    - { path: ^/api/public, roles: PUBLIC_ACCESS }
    - { path: ^/api, roles: ROLE_USER }
    - { path: ^/capitals/test$, roles: PUBLIC_ACCESS }
    - { path: ^/capitals/high-scores, roles: PUBLIC_ACCESS }
    - { path: ^/capitals, roles: ROLE_USER }